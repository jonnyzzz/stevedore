# Repositories (Deployments)

Stevedore manages deployments by polling Git repositories. The recommended onboarding flow is SSH
deploy keys (read-only).

If you installed Stevedore from a Git checkout, `stevedore-install.sh` bootstraps a `stevedore`
deployment automatically (so Stevedore can manage itself later).

## Repository Access Policy (planned)

- Recommended: SSH deploy keys (read-only) per deployment (keypair generated by Stevedore).
- Alternative: HTTPS with tokens (broader scope than deploy keys).
- Future hardening (v4): keep private keys encrypted in the SQLCipher DB and forward via SSH agent.

## Add a Repository

```bash
stevedore repo add <deployment> <git-url> --branch <branch>
```

`--branch` defaults to `main` if omitted.

Example:

```bash
stevedore repo add homepage git@github.com:acme/homepage.git --branch main
```

This creates the deployment state directory, generates an SSH keypair, and stores the repository URL
and branch.

## Get the Public Deploy Key

```bash
stevedore repo key <deployment>
```

Add the printed public key to the Git hosting provider as a **read-only deploy key**.

### GitHub UI

1. Open repository → **Settings**
2. **Deploy keys** → **Add deploy key**
3. Paste the public key
4. Keep **Allow write access** unchecked

### GitHub CLI (read-only)

```bash
gh api -X POST repos/<owner>/<repo>/keys \
  -f title="stevedore-<deployment>" \
  -f key="$(stevedore repo key <deployment>)" \
  -F read_only=true
```

## Where the Keys Live

Current:

- Private key: `/opt/stevedore/deployments/<deployment>/repo/ssh/id_ed25519`
- Public key: `/opt/stevedore/deployments/<deployment>/repo/ssh/id_ed25519.pub`

Planned (v4):

- Private key: stored encrypted in `system/stevedore.db`; no private key files on disk.
- Git auth: via forwarded SSH agent socket into the git worker container.

## Alternatives (Options)

- **HTTPS + token**: simpler for some setups, but tokens are broader than deploy keys.
- **SSH agent forwarding**: convenient for dev, but harder to make reproducible.

## Compose Entrypoint

Each repository must have a Compose file at repo root. Preferred filename: `docker-compose.yaml`.

Stevedore also accepts: `docker-compose.yml`, `compose.yaml`, `compose.yml` (and `stevedore.yaml` as legacy).
