# Implementation Plan (Community + PRO roadmap)

This project is intentionally Docker-first: the host installs as little as possible, then Stevedore
runs in a container and keeps all state under a single mounted directory (`/opt/stevedore` by default).

See `docs/ARCHITECTURE.md` for the longer-form design notes and open questions.

## Guiding Principles

- Minimal host dependencies (close to “Docker-only” on Ubuntu / Raspberry Pi OS).
- State is a directory tree on disk (easy backups, easy audits, easy recovery).
- Clear console logs and deterministic behavior.
- Prefer simple, well-tested flows over complex rollback logic at this stage.
- Community and PRO are *documentation-level* concepts for now (no code-level gating yet).

## Definitions

- **Stevedore instance**: one Stevedore installation on a host.
- **Deployment** (deployment unit): one Git repository managed by Stevedore.

## Milestone 0 — Bootstrap (what we implement first)

1. **Installer**
   - `stevedore-install.sh` supports Ubuntu and Raspberry Pi OS.
   - Installs missing prerequisites (Docker) and asks for `sudo` when required.
   - Builds the Stevedore image locally (`docker build`).
   - Installs and enables `stevedore.service` (systemd) to keep Stevedore running across reboots.
   - The container runs the daemon via `stevedore -d`.
   - Writes a container env file under `system/container.env`.
   - Creates the host wrapper `stevedore.sh`.
   - Bootstraps a `stevedore` deployment (self-management) when installed from a Git checkout.
   - Planned: installer also creates a `stevedore` command (no `.sh`) in `PATH`.
   - Planned: “curl | sh” install path for public forks (private forks require manual auth setup).
2. **Fork warning**
   - The running container warns if installed from upstream `github.com/jonnyzzz/stevedore` `main`.
   - README explicitly requires installing from a fork.
3. **State layout**
   - A single state root directory (default `/opt/stevedore`), mounted into the container.
   - Per-deployment folders created on registration.
4. **Repository onboarding**
   - `stevedore.sh repo add …` registers a repo and generates an SSH deploy key.
   - The tool prints the public key and instructions to add it as a read-only Deploy Key.
5. **Parameters store (secrets)**
   - Parameters stored in a local SQLite database under `system/stevedore.db`.
   - Database is encrypted at rest using SQLCipher.
   - Database password is generated by the installer and stored at `system/db.key` (and must be backed up).
6. **CI**
   - Integration smoke tests run in Docker (driven by a Python script).
   - GitHub Actions runs unit + integration tests automatically.
7. **Build metadata**
   - Docker build embeds: `VERSION`, git remote (sanitized), git commit, UTC build date.
   - Exposed via `stevedore version`.

## Milestone 1 — Status + HTTP API (Community)

- Add `stevedore status` to list deployments and their last known state.
- Add an HTTP server to the daemon (planned port `42107`) with:
  - unauthenticated `/healthz` (for service monitoring)
  - admin-authenticated status + manual triggers
  - admin-authenticated repository registration
- Installer generates and persists an admin key under `system/` and injects it into the container.
- Ensure there is always a `stevedore` deployment (self-management baseline).

## Milestone 2 — Git sync loop (Community)

- Poll interval + scheduler.
- Run Git operations in a dedicated worker container (isolation).
- Use the generated deploy key for SSH Git access (read-only).
- v4 hardening: store private keys encrypted in the DB and forward via SSH agent (no key files on disk).
- Persist last-seen revision and sync status in the state directory.
- Manual sync trigger via CLI + HTTP API.

## Milestone 3 — Deploy engine (Community)

- Repository contract:
  - `docker-compose.yaml` at repo root (recommended); also support `docker-compose.yml`, `compose.yaml`, `compose.yml`.
  - `stevedore.yaml` remains supported as a legacy name.
- Standard mounts / env:
  - Provide `${STEVEDORE_DATA}`, `${STEVEDORE_LOGS}`, `${STEVEDORE_SHARED}` to Compose and back them by predictable host paths.
- Build:
  - Build images with deterministic tags derived from commit SHA.
- Deploy:
  - Apply compose in a predictable way (project naming per deployment).
  - **Rollback logic stays simple**: prefer “don’t take down the current version unless the new one is healthy”.
- Run `docker compose` applies in a dedicated worker container (isolation).
- Stream workload container logs into `/opt/stevedore/deployments/<deployment>/logs/…` with best-effort secret redaction.

## Milestone 4 — Self-update + resilience (Community)

- Self-update workflow:
  - detect Stevedore repo changes
  - build a new Stevedore image
  - use an update worker container to stop/replace the running Stevedore control-plane container
  - do not stop workload containers during Stevedore restarts
- Health monitoring:
  - container exposes `/healthz` on `:42107`
  - systemd restarts Stevedore if it becomes unhealthy (Docker does not restart unhealthy containers by itself)

## Milestone 5 — Observability + operations (Community)

- Structured logs (console first, then UI).
- State introspection commands (status, last errors, last deploy revision).
- Backup / restore guidance (`tar` the state directory).
- Container labels (v3): label all Stevedore-managed containers to make `docker ps`/`docker inspect` readable.

## PRO Roadmap (documentation-level)

- Web UI (React) (logs viewer + manual triggers).
- Advanced rollbacks (multiple versions, retention).
- Notifications (Slack/Webhooks).
- AuthN/AuthZ for UI and API.
- External secrets backends (SOPS/Vault/Cloud secret managers).
- Multi-arch release pipelines (arm64/armv7) and Raspberry Pi validation.
