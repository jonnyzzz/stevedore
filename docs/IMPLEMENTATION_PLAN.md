# Implementation Plan (Community + PRO roadmap)

This project is intentionally Docker-first: the host installs as little as possible, then Stevedore
runs in a container and keeps all state under a single mounted directory (`/opt/stevedore` by default).

## Guiding Principles

- Minimal host dependencies (close to “Docker-only” on Ubuntu / Raspberry Pi OS).
- State is a directory tree on disk (easy backups, easy audits, easy recovery).
- Clear console logs and deterministic behavior.
- Prefer simple, well-tested flows over complex rollback logic at this stage.
- Community and PRO are *documentation-level* concepts for now (no code-level gating yet).

## Definitions

- **Stevedore instance**: one Stevedore installation on a host.
- **Deployment** (deployment unit): one Git repository managed by Stevedore.

## Milestone 0 — Bootstrap (what we implement first)

1. **Installer**
   - `stevedore-install.sh` supports Ubuntu and Raspberry Pi OS.
   - Installs missing prerequisites (Docker) and asks for `sudo` when required.
   - Builds the Stevedore image locally (`docker build`).
   - Installs and enables `stevedore.service` (systemd) to keep Stevedore running across reboots.
   - The container runs the daemon via `stevedore -d`.
   - Writes a container env file under `system/container.env`.
   - Creates the host wrapper `stevedore.sh`.
   - Bootstraps a `stevedore` deployment (self-management) when installed from a Git checkout.
2. **Fork warning**
   - The running container warns if installed from upstream `github.com/jonnyzzz/stevedore` `main`.
   - README explicitly requires installing from a fork.
3. **State layout**
   - A single state root directory (default `/opt/stevedore`), mounted into the container.
   - Per-deployment folders created on registration.
4. **Repository onboarding**
   - `stevedore.sh repo add …` registers a repo and generates an SSH deploy key.
   - The tool prints the public key and instructions to add it as a read-only Deploy Key.
5. **Parameters store (secrets)**
   - Parameters stored in a local SQLite database under `system/stevedore.db`.
   - Database is encrypted at rest using SQLCipher.
   - Database password is generated by the installer and stored at `system/db.key` (and must be backed up).
6. **CI**
   - Integration smoke tests run in Docker (driven by a Python script).
   - GitHub Actions runs unit + integration tests automatically.
7. **Build metadata**
   - Docker build embeds: `VERSION`, git remote (sanitized), git commit, UTC build date.
   - Exposed via `stevedore version`.

## Milestone 1 — Git sync loop (Community)

- Poll interval + scheduler.
- Clone/pull via the generated deploy key.
- Persist last-seen revision and sync status in the state directory.
- Manual sync trigger via CLI.

## Milestone 2 — Deploy engine (Community)

- Repository contract:
  - `docker-compose.yaml` at repo root (recommended); also support `docker-compose.yml`, `compose.yaml`, `compose.yml`.
  - `stevedore.yaml` remains supported as a legacy name.
- Standard mounts / env:
  - Provide `${STEVEDORE_DATA}`, `${STEVEDORE_LOGS}`, `${STEVEDORE_SHARED}` to Compose and back them by predictable host paths.
- Build:
  - Build images with deterministic tags derived from commit SHA.
- Deploy:
  - Apply compose in a predictable way (project naming per deployment).
  - **Rollback logic stays simple**: prefer “don’t take down the current version unless the new one is healthy”.

## Milestone 3 — Observability + operations (Community)

- Structured logs (console first).
- State introspection commands (list deployments, status, last errors).
- Backup / restore guidance (`tar` the state directory).

## PRO Roadmap (documentation-level)

- Web UI (logs viewer + manual triggers).
- Advanced rollbacks (multiple versions, retention).
- Notifications (Slack/Webhooks).
- AuthN/AuthZ for UI and API.
- External secrets backends (SOPS/Vault/Cloud secret managers).
