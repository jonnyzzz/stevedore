# State Layout

Stevedore keeps its **source of truth** as a directory tree on the host, mounted into the running
Stevedore container.

## Root

- Default: `/opt/stevedore`
- Host override (installer): `STEVEDORE_HOST_ROOT`
- Container override: `STEVEDORE_ROOT`

## Layout

```
/opt/stevedore/
  system/
    db.key                      # SQLCipher key (generated by installer)
    container.env               # container environment (written by installer)
    admin.key                   # admin/API key for HTTP control plane (generated by installer)
    update.log                  # self-update worker log (created on demand)
    ssh-agent/                  # shared SSH agent socket directory (planned, v4)
      agent.sock                # UNIX socket for forwarding to git worker containers
    stevedore.db                # SQLCipher-encrypted SQLite DB (deployments, parameters, etc)
    install.json                # (optional) installer metadata
    logs/                       # Stevedore (control-plane) logs (planned)
  deployments/
    <deployment>/
      repo/
        url.txt                 # git URL
        branch.txt              # branch name
        git/                    # git checkout / bare repo (implementation detail)
        ssh/
          id_ed25519            # generated deploy key (private)
          id_ed25519.pub        # generated deploy key (public)
      parameters/               # reserved / legacy (secrets are NOT stored as plaintext files)
      runtime/
        ...                     # derived state (last sync, last deploy, etc)
      data/                     # per-deployment persistent volumes (Community)
      logs/                     # per-deployment logs (Community)
        containers/             # streamed `docker logs` output (planned)
  shared/                       # shared volumes (planned)
```

## Notes

- **Do not commit** anything from `/opt/stevedore` into Git.
- Prefer using `stevedore` to modify state instead of editing files directly (`stevedore.sh` also works).
- Most directories are created on-demand (installer creates `system/` and `deployments/`; `repo add` creates the per-deployment subfolders).
- `system/container.env` is used by the installed `stevedore.service` systemd unit (`/etc/systemd/system/stevedore.service`).
- v4 plan: SSH private keys move into the encrypted DB (`system/stevedore.db`) and are forwarded via an SSH agent socket; no private key files on disk.
- Backups are trivial: stop the container, then archive `/opt/stevedore/`.
